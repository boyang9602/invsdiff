package ca.concordia.apr.invsdiff;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.PrintWriter;
import java.security.NoSuchAlgorithmException;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.json.JSONObject;

import ca.concordia.apr.invsdiff.comparasion.Comparator;
import ca.concordia.apr.invsdiff.comparasion.Result;

/**
 * Compare similar invariants file generated by daikon, i.e. invariants of slightly different versions
 *
 */
public class App 
{
    public static void main( String[] args ) throws FileNotFoundException, IOException, NoSuchAlgorithmException
    {
    	if (args.length < 2) {
    		System.out.println("Usage: \nca.concordia.apr.invsdiff.App invsfile0 invsfile1 invsfile2 ...");
    		System.exit(1);
    	}
    	List<InvsFile> invsFiles = new LinkedList<InvsFile>();
        for (int j = 0; j < args.length; j++) {
        	if (args[j].startsWith("--")) {
        	} else {
        		invsFiles.add(new InvsFile(args[j]));
        	}
        }
        Set<String> allPpts = new HashSet<String>();

        int index = 0;
    	String[] filenames = new String[invsFiles.size()];
        for (InvsFile invsFile : invsFiles) {
        	allPpts.addAll(invsFile.getPptNamesSet());
        	filenames[index++] = invsFile.getFilename();
        }
        Map<String, Set<Result>> classResultMap = new HashMap<String, Set<Result>>();
        for (String pptName : allPpts) {
        	Map<String, Ppt> tbc = new HashMap<String, Ppt>();
        	for (InvsFile invsFile : invsFiles) {
        		tbc.put(invsFile.getFilename(), invsFile.getPptByName(pptName));
        	}
        	Result result = Comparator.compare(pptName, tbc);
        	Set<Result> resultSet = classResultMap.getOrDefault(result.getClassName(), new HashSet<Result>());
        	resultSet.add(result);
        	classResultMap.put(result.getClassName(), resultSet);
        }

        File file = new File("diff-summary-" + String.join("-", filenames) + ".csv");
        PrintWriter pw = new PrintWriter(file);
        StringBuffer title = new StringBuffer();
        title.append("ppt,common,");
        for (String filename : filenames) {
        	title.append(filename).append(',');
        }
        title.setCharAt(title.length() - 1, '\n');
        pw.write(title.toString());
        for (String className : classResultMap.keySet()) {
//        	JSONObject tmp = new JSONObject();
//        	for (Result result : classResultMap.get(className)) {
//        		result.appendToJSON(tmp);
//        	}
        	for (Result result : classResultMap.get(className)) {
        		StringBuffer sb = new StringBuffer();
        		sb.append('\"').append(result.getPptName()).append('\"').append(',');
        		for (Integer ele : result.getSummary(filenames)) {
        			sb.append(ele).append(',');
        		}
        		sb.setCharAt(sb.length() - 1, '\n');
        		pw.write(sb.toString());
        	}
        }
        pw.close();
    }
}
